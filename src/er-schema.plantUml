@startuml Temanku_ERD

!define PRIMARY_KEY(x) <b><color:#b8861b><&key></color> x</b>
!define FOREIGN_KEY(x) <color:#aaaaaa><&key></color> x
!define COLUMN(x) <color:#efefef><&media-record></color> x
!define TABLE(x) entity x << (T, white) >>
!define STAGING_TABLE(x) entity x << (S, lightblue) >>

' User Management
TABLE(USERS) {
    PRIMARY_KEY(user_id) : INT
    --
    COLUMN(username) : VARCHAR(100)
    COLUMN(email) : VARCHAR(255)
    COLUMN(password_hash) : VARCHAR(255)
    COLUMN(role) : ENUM('admin', 'supplier')
    COLUMN(full_name) : VARCHAR(255)
    COLUMN(phone) : VARCHAR(20)
    COLUMN(is_active) : BOOLEAN
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Business Partner/Supplier
TABLE(BUSINESS_PARTNERS) {
    PRIMARY_KEY(bp_id) : INT
    --
    FOREIGN_KEY(user_id) : INT
    COLUMN(bp_code) : VARCHAR(50)
    COLUMN(bp_name) : VARCHAR(255)
    COLUMN(company_address) : TEXT
    COLUMN(tax_id_number) : VARCHAR(50)
    COLUMN(contact_person) : VARCHAR(255)
    COLUMN(contact_email) : VARCHAR(255)
    COLUMN(contact_phone) : VARCHAR(20)
    COLUMN(is_active) : BOOLEAN
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Purchase Orders
TABLE(PURCHASE_ORDERS) {
    PRIMARY_KEY(po_id) : INT
    --
    COLUMN(po_no) : VARCHAR(100)
    FOREIGN_KEY(bp_id) : INT
    COLUMN(po_reference) : VARCHAR(100)
    COLUMN(po_date) : DATE
    COLUMN(currency) : VARCHAR(3)
    COLUMN(total_amount) : DECIMAL(15,2)
    COLUMN(status) : ENUM('open', 'partially_received', 'fully_received', 'cancelled')
    COLUMN(description) : TEXT
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Goods Receipt
TABLE(GOODS_RECEIPTS) {
    PRIMARY_KEY(gr_id) : INT
    --
    COLUMN(gr_no) : VARCHAR(100)
    COLUMN(receipt_no) : VARCHAR(100)
    FOREIGN_KEY(bp_id) : INT
    COLUMN(actual_receipt_date) : DATE
    COLUMN(packing_slip) : VARCHAR(100)
    COLUMN(status) : ENUM('received', 'invoiced', 'closed')
    COLUMN(notes) : TEXT
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' PO Line Items
TABLE(PO_LINE_ITEMS) {
    PRIMARY_KEY(po_line_id) : INT
    --
    FOREIGN_KEY(po_id) : INT
    FOREIGN_KEY(gr_id) : INT
    COLUMN(receipt_line) : VARCHAR(50)
    COLUMN(item_no) : VARCHAR(100)
    COLUMN(ics_code) : VARCHAR(50)
    COLUMN(ics_part) : VARCHAR(100)
    COLUMN(part_no) : VARCHAR(100)
    COLUMN(part_name) : VARCHAR(255)
    COLUMN(request_qty) : DECIMAL(12,4)
    COLUMN(actual_receipt_qty) : DECIMAL(12,4)
    COLUMN(approve_qty) : DECIMAL(12,4)
    COLUMN(unit) : VARCHAR(20)
    COLUMN(receipt_amount) : DECIMAL(15,2)
    COLUMN(receipt_unit_price) : DECIMAL(15,4)
    COLUMN(currency) : VARCHAR(3)
    COLUMN(remaining_qty_to_invoice) : DECIMAL(12,4)
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Invoice Headers
TABLE(INVOICES) {
    PRIMARY_KEY(inv_id) : INT
    --
    COLUMN(inv_no) : VARCHAR(100)
    COLUMN(inv_doc_no) : VARCHAR(100)
    COLUMN(inv_supplier_no) : VARCHAR(100)
    FOREIGN_KEY(bp_id) : INT
    COLUMN(inv_date) : DATE
    COLUMN(inv_doc_date) : DATE
    COLUMN(inv_due_date) : DATE
    COLUMN(plan_date) : DATE
    COLUMN(actual_date) : DATE
    COLUMN(inv_faktur) : VARCHAR(100)
    COLUMN(inv_faktur_date) : DATE
    COLUMN(receipt_number) : VARCHAR(100)
    COLUMN(total_dpp) : DECIMAL(15,2)
    COLUMN(status) : ENUM('new', 'in_process', 'verified', 'ready_to_payment', 'paid', 'rejected')
    FOREIGN_KEY(verified_by) : INT
    COLUMN(verified_at) : TIMESTAMP
    COLUMN(notes) : TEXT
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Invoice Line Items
TABLE(INVOICE_LINE_ITEMS) {
    PRIMARY_KEY(inv_line_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    FOREIGN_KEY(po_line_id) : INT
    COLUMN(po_no) : VARCHAR(100)
    COLUMN(receipt_line) : VARCHAR(50)
    COLUMN(item_no) : VARCHAR(100)
    COLUMN(part_no) : VARCHAR(100)
    COLUMN(part_name) : VARCHAR(255)
    COLUMN(inv_qty) : DECIMAL(12,4)
    COLUMN(inv_amount) : DECIMAL(15,2)
    COLUMN(unit) : VARCHAR(20)
    COLUMN(currency) : VARCHAR(3)
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' PPN Master
TABLE(PPN_TYPES) {
    PRIMARY_KEY(ppn_id) : INT
    --
    COLUMN(ppn_code) : VARCHAR(20)
    COLUMN(ppn_name) : VARCHAR(100)
    COLUMN(ppn_rate) : DECIMAL(5,4)
    COLUMN(description) : TEXT
    COLUMN(is_active) : BOOLEAN
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Invoice PPN
TABLE(INVOICE_PPN) {
    PRIMARY_KEY(invoice_ppn_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    FOREIGN_KEY(ppn_id) : INT
    COLUMN(tax_base_amount) : DECIMAL(15,2)
    COLUMN(tax_amount) : DECIMAL(15,2)
    COLUMN(created_at) : TIMESTAMP
}

' PPh Master
TABLE(PPH_TYPES) {
    PRIMARY_KEY(pph_id) : INT
    --
    COLUMN(pph_code) : VARCHAR(20)
    COLUMN(pph_name) : VARCHAR(100)
    COLUMN(default_rate) : DECIMAL(5,4)
    COLUMN(description) : TEXT
    COLUMN(is_active) : BOOLEAN
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Invoice PPh
TABLE(INVOICE_PPH) {
    PRIMARY_KEY(invoice_pph_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    FOREIGN_KEY(pph_id) : INT
    COLUMN(pph_base_amount) : DECIMAL(15,2)
    COLUMN(pph_amount) : DECIMAL(15,2)
    COLUMN(created_at) : TIMESTAMP
}

' Invoice Totals
TABLE(INVOICE_TOTALS) {
    PRIMARY_KEY(inv_total_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    COLUMN(subtotal) : DECIMAL(15,2)
    COLUMN(total_ppn_amount) : DECIMAL(15,2)
    COLUMN(total_pph_amount) : DECIMAL(15,2)
    COLUMN(total_amount) : DECIMAL(15,2)
    COLUMN(calculated_at) : TIMESTAMP
}

' Payment Documents
TABLE(PAYMENT_DOCUMENTS) {
    PRIMARY_KEY(payment_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    COLUMN(payment_doc) : VARCHAR(100)
    COLUMN(payment_doc_date) : DATE
    COLUMN(payment_amount) : DECIMAL(15,2)
    COLUMN(payment_status) : ENUM('pending', 'completed', 'cancelled')
    COLUMN(payment_notes) : TEXT
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' News/Announcements
TABLE(NEWS) {
    PRIMARY_KEY(news_id) : INT
    --
    FOREIGN_KEY(created_by) : INT
    COLUMN(title) : VARCHAR(255)
    COLUMN(content) : TEXT
    COLUMN(published_date) : DATE
    COLUMN(is_active) : BOOLEAN
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' Email Logs
TABLE(EMAIL_LOGS) {
    PRIMARY_KEY(email_log_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    COLUMN(recipient_email) : VARCHAR(255)
    COLUMN(email_type) : VARCHAR(50)
    COLUMN(status) : ENUM('sent', 'failed', 'pending')
    COLUMN(email_content) : TEXT
    COLUMN(sent_at) : TIMESTAMP
    COLUMN(created_at) : TIMESTAMP
}

' Document Attachments
TABLE(INVOICE_DOCUMENTS) {
    PRIMARY_KEY(document_id) : INT
    --
    FOREIGN_KEY(inv_id) : INT
    COLUMN(file_name) : VARCHAR(255)
    COLUMN(file_path) : VARCHAR(500)
    COLUMN(file_type) : VARCHAR(50)
    COLUMN(file_size) : INT
    COLUMN(document_type) : VARCHAR(50)
    COLUMN(uploaded_at) : TIMESTAMP
}

' System Configuration
TABLE(SYSTEM_CONFIG) {
    PRIMARY_KEY(config_id) : INT
    --
    COLUMN(config_key) : VARCHAR(100)
    COLUMN(config_value) : TEXT
    COLUMN(description) : TEXT
    COLUMN(updated_at) : TIMESTAMP
}

' ERP Staging Table - INDEPENDENT, NO FOREIGN KEYS
STAGING_TABLE(ERP_STAGING_DATA) {
    PRIMARY_KEY(staging_id) : BIGINT
    --
    COLUMN(erp_sync_id) : VARCHAR(100) 
    COLUMN(sync_batch_id) : VARCHAR(100)
    COLUMN(data_type) : ENUM('BP', 'PO', 'DN', 'PO_LINE', 'DN_LINE')
    COLUMN(operation_type) : ENUM('INSERT', 'UPDATE', 'DELETE')
    --
    ' Business Partner Fields
    COLUMN(erp_bp_id) : VARCHAR(50)
    COLUMN(bp_code) : VARCHAR(50)
    COLUMN(company_name) : VARCHAR(255)
    COLUMN(company_address) : TEXT
    COLUMN(tax_id_number) : VARCHAR(50)
    COLUMN(contact_person) : VARCHAR(255)
    COLUMN(contact_email) : VARCHAR(255)
    COLUMN(contact_phone) : VARCHAR(20)
    --
    ' Purchase Order Header Fields
    COLUMN(erp_po_id) : VARCHAR(50)
    COLUMN(po_no) : VARCHAR(100)
    COLUMN(po_reference) : VARCHAR(100)
    COLUMN(po_date) : DATE
    COLUMN(po_currency) : VARCHAR(3)
    COLUMN(po_total_amount) : DECIMAL(15,2)
    COLUMN(po_status) : VARCHAR(50)
    COLUMN(po_description) : TEXT
    --
    ' Delivery Note / Goods Receipt Header Fields
    COLUMN(erp_dn_id) : VARCHAR(50)
    COLUMN(dn_no) : VARCHAR(100)
    COLUMN(gr_no) : VARCHAR(100)
    COLUMN(receipt_no) : VARCHAR(100)
    COLUMN(actual_receipt_date) : DATE
    COLUMN(packing_slip) : VARCHAR(100)
    COLUMN(dn_status) : VARCHAR(50)
    --
    ' Line Item Fields (for both PO and DN)
    COLUMN(erp_line_id) : VARCHAR(50)
    COLUMN(parent_erp_id) : VARCHAR(50)
    COLUMN(receipt_line) : VARCHAR(50)
    COLUMN(item_no) : VARCHAR(100)
    COLUMN(ics_code) : VARCHAR(50)
    COLUMN(ics_part) : VARCHAR(100)
    COLUMN(part_no) : VARCHAR(100)
    COLUMN(part_name) : VARCHAR(255)
    COLUMN(request_qty) : DECIMAL(12,4)
    COLUMN(actual_receipt_qty) : DECIMAL(12,4)
    COLUMN(approve_qty) : DECIMAL(12,4)
    COLUMN(unit) : VARCHAR(20)
    COLUMN(receipt_amount) : DECIMAL(15,2)
    COLUMN(receipt_unit_price) : DECIMAL(15,4)
    COLUMN(line_currency) : VARCHAR(3)
    --
    ' Sync Control Fields
    COLUMN(sync_status) : ENUM('PENDING', 'PROCESSED', 'ERROR', 'SKIPPED')
    COLUMN(error_message) : TEXT
    COLUMN(processed_at) : TIMESTAMP
    COLUMN(retry_count) : INT
    COLUMN(is_active) : BOOLEAN
    --
    ' ERP Source Fields
    COLUMN(erp_created_at) : TIMESTAMP
    COLUMN(erp_updated_at) : TIMESTAMP
    COLUMN(erp_created_by) : VARCHAR(100)
    COLUMN(erp_updated_by) : VARCHAR(100)
    --
    ' System Fields
    COLUMN(created_at) : TIMESTAMP
    COLUMN(updated_at) : TIMESTAMP
}

' ERP Sync Log - INDEPENDENT
STAGING_TABLE(ERP_SYNC_LOG) {
    PRIMARY_KEY(sync_log_id) : BIGINT
    --
    COLUMN(sync_batch_id) : VARCHAR(100)
    COLUMN(sync_type) : ENUM('FULL', 'INCREMENTAL', 'MANUAL')
    COLUMN(data_types) : VARCHAR(255)
    COLUMN(sync_status) : ENUM('STARTED', 'IN_PROGRESS', 'COMPLETED', 'FAILED', 'PARTIAL')
    COLUMN(total_records) : INT
    COLUMN(processed_records) : INT
    COLUMN(success_records) : INT
    COLUMN(error_records) : INT
    COLUMN(skipped_records) : INT
    COLUMN(sync_started_at) : TIMESTAMP
    COLUMN(sync_completed_at) : TIMESTAMP
    COLUMN(sync_duration_seconds) : INT
    COLUMN(error_summary) : TEXT
    COLUMN(sync_triggered_by) : VARCHAR(100)
    COLUMN(created_at) : TIMESTAMP
}

' Relationships
USERS ||--o{ BUSINESS_PARTNERS : user_id
USERS ||--o{ NEWS : created_by
USERS ||--o{ INVOICES : verified_by

BUSINESS_PARTNERS ||--o{ PURCHASE_ORDERS : bp_id
BUSINESS_PARTNERS ||--o{ GOODS_RECEIPTS : bp_id
BUSINESS_PARTNERS ||--o{ INVOICES : bp_id

PURCHASE_ORDERS ||--o{ PO_LINE_ITEMS : po_id
GOODS_RECEIPTS ||--o{ PO_LINE_ITEMS : gr_id

INVOICES ||--o{ INVOICE_LINE_ITEMS : inv_id
INVOICES ||--o{ INVOICE_PPN : inv_id
INVOICES ||--o{ INVOICE_PPH : inv_id
INVOICES ||--o{ INVOICE_TOTALS : inv_id
INVOICES ||--o{ PAYMENT_DOCUMENTS : inv_id
INVOICES ||--o{ EMAIL_LOGS : inv_id
INVOICES ||--o{ INVOICE_DOCUMENTS : inv_id

PO_LINE_ITEMS ||--o{ INVOICE_LINE_ITEMS : po_line_id

PPN_TYPES ||--o{ INVOICE_PPN : ppn_id
PPH_TYPES ||--o{ INVOICE_PPH : pph_id

@enduml